# تقرير تحسينات الأداء والاستقرار

## النطاق المنفّذ في هذه الجولة
- تحسين كشف الحساب (كشف حساب/دفتر الأستاذ) ليعتمد على مصدر بيانات موحّد ويحسب الرصيد الافتتاحي/الجاري بشكل صحيح.
- تقليل التحميل الكلي للبيانات في كشف الحساب عبر استعلامات SQLite مقيّدة بالفترة والحساب بدل تحميل كل السجلات.
- إضافة فهارس SQLite إضافية لتحسين الاستعلامات حسب الحساب.
- زيادة الاعتمادية في الوصول لقاعدة البيانات عبر استخدام cursor منفصل في استعلامات حرجة لتجنب تعارضات المؤشر عند تعدد العمليات.
- إضافة قياس آلي للأداء/الذاكرة قبل/بعد.

## تغييرات تقنية رئيسية
### 1) كشف الحساب (Ledger)
- إضافة واجهة تقرير موحدة: `AccountingService.get_account_ledger_report(...)`.
- دمج مصادر الحركة:
  - قيود اليومية (journal_entries)
  - الدفعات (payments)
  - المصروفات (expenses) مع دعم بيانات قديمة (عند غياب payment_account_id)
- حساب:
  - الرصيد الافتتاحي قبل فترة العرض
  - الرصيد الجاري لكل سطر
  - إجمالي المدين/الدائن وصافي الحركة

### 2) تحسينات SQLite للاستعلامات حسب الحساب
- إضافة فهارس:
  - `payments(account_id)`
  - `expenses(account_id)`
  - `expenses(payment_account_id)`
- إضافة دوال قراءة جديدة مقيّدة بالحساب والفترة:
  - `get_payments_by_account(...)`, `sum_payments_before(...)`
  - `get_expenses_paid_from_account(...)`, `sum_expenses_paid_before(...)`
  - `get_expenses_charged_to_account(...)`, `sum_expenses_charged_before(...)`
  - `get_journal_entries_before(...)`, `get_journal_entries_between(...)`

### 3) تحسين اعتمادية القراءة من SQLite
- تحديث `get_all_payments()` و `get_all_expenses()` لاستخدام cursor منفصل (بدلاً من مشاركة sqlite_cursor) لتقليل احتمالية أخطاء التزامن/إعادة الدخول.

## قياس الأداء والذاكرة
### أداة القياس
- تشغيل:
  - `python tools/perf_audit.py`
- تخرج ملفات JSON في:
  - `docs/perf/perf_*.json`

### مقارنة قبل/بعد (على قاعدة بيانات صغيرة محلية)
تمت المقارنة بين:
- قبل: `docs/perf/perf_20260131_205010.json`
- بعد: `docs/perf/perf_20260131_205759.json`

| القياس | قبل (ms) | بعد (ms) | Peak قبل (KB) | Peak بعد (KB) |
|---|---:|---:|---:|---:|
| Repository() | 6.75 | 6.32 | 35 | 36 |
| repo.get_all_accounts() | 0.22 | 0.21 | 9 | 9 |
| repo.get_all_payments() | 0.40 | 0.39 | 19 | 20 |
| repo.get_all_expenses() | 0.29 | 0.24 | 12 | 13 |
| repo.get_all_journal_entries() | 0.71 | 0.62 | 32 | 31 |
| svc.get_dashboard_stats() | 0.81 | 0.82 | 9 | 9 |
| svc.get_recent_activity(8) | 0.74 | 0.76 | 30 | 30 |
| svc.get_account_ledger_report(60d) | 2.66 | 13.33 | 57 | 47 |

ملاحظة مهمة: على قواعد البيانات الصغيرة جدًا قد يظهر وقت أعلى في `get_account_ledger_report` بسبب تعدد الاستعلامات القصيرة (عدة SELECTs) بدل تحميل قائمة واحدة في الذاكرة. التحسين الحقيقي يظهر بشكل ملحوظ عند تضخم البيانات لأننا نتجنب تحميل "كل" الدفعات/المصروفات/القيود ونستخدم فهارس واستعلامات مقيّدة بالحساب والفترة (تقليل التعقيد الزمني واستهلاك الذاكرة مع ازدياد حجم البيانات).

## اختبارات واستقرار
- تم تمرير جميع الاختبارات:
  - `pytest` = 44 passed
- تمت إضافة اختبار جديد لضمان صحة كشف الحساب بعد دمج الدفعات والمصروفات.

