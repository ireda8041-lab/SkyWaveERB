# ๐ ุฏููู ุงูุชุฑุญูู ูู ุงููุธุงู ุงููุฏูู ุฅูู ุงููุธุงู ุงูุฌุฏูุฏ

## ๐ ุงููุฑู ุจูู ุงููุธุงููู

### ุงููุธุงู ุงููุฏูู (4 ุฃุฑูุงู):
```
1200 โ ุงูุนููุงุก
4100 โ ุฅูุฑุงุฏุงุช ุงูุฎุฏูุงุช
5900 โ ูุตุฑููุงุช ูุชููุนุฉ
1111 โ ุงูุฎุฒูุฉ ุงูุฑุฆูุณูุฉ
```

### ุงููุธุงู ุงูุฌุฏูุฏ (6 ุฃุฑูุงู):
```
112100 โ ุนููุงุก ุชุฌุงุฑููู (B2B)
112200 โ ุนููุงุก ุฃูุฑุงุฏ (B2C)
410100 โ ุฅูุฑุงุฏุงุช ุฎุฏูุงุช ุงูุชุณููู ุงูุฑููู
410200 โ ุฅูุฑุงุฏุงุช ุชุทููุฑ ุงูููุงูุน
510001 โ ููุฒุงููุฉ ุฅุนูุงูุงุช (COGS)
620001 โ ุฑูุงุชุจ ุงูููุธููู (OPEX)
111101 โ ุงูุฎุฒูุฉ ุงูุฑุฆูุณูุฉ
```

---

## ๐ฏ ุฎุทุฉ ุงูุชุฑุญูู (3 ุฎูุงุฑุงุช)

### ุงูุฎูุงุฑ 1๏ธโฃ: ุงูุชุฑุญูู ุงููุงูู (ููุตู ุจู ููุดุฑูุงุช ุงูุฌุฏูุฏุฉ)

**ุงูุฎุทูุงุช:**
1. ุนูู ูุณุฎุฉ ุงุญุชูุงุทูุฉ ูุงููุฉ
2. ุญุฐู ุงูุญุณุงุจุงุช ุงููุฏููุฉ
3. ุงุณุชูุฑุงุฏ ุงูุดุฌุฑุฉ ุงูุฌุฏูุฏุฉ
4. ุชุญุฏูุซ ุฃููุงุฏ ุงูุญุณุงุจุงุช ูู `accounting_service.py`

```bash
# 1. ูุณุฎุฉ ุงุญุชูุงุทูุฉ
python -c "from core.repository import Repository; r = Repository(); import json; accounts = r.get_all_accounts(); json.dump([a.model_dump() for a in accounts], open('backup_accounts.json', 'w', encoding='utf-8'), ensure_ascii=False, indent=2)"

# 2. ุญุฐู ุงููุฏูู ูุงุณุชูุฑุงุฏ ุงูุฌุฏูุฏ
python import_chart_of_accounts.py --clear --force
```

**ุชุญุฏูุซ ุงูุฃููุงุฏ ูู `accounting_service.py`:**
```python
# ุงููุฏูู (4 ุฃุฑูุงู)
ACC_RECEIVABLE_CODE = "1200"
SERVICE_REVENUE_CODE = "4100"
CASH_ACCOUNT_CODE = "1111"

# ุงูุฌุฏูุฏ (6 ุฃุฑูุงู)
ACC_RECEIVABLE_CODE = "112100"  # ุนููุงุก ุชุฌุงุฑููู
SERVICE_REVENUE_CODE = "410100"  # ุฅูุฑุงุฏุงุช ุฎุฏูุงุช ุงูุชุณููู
CASH_ACCOUNT_CODE = "111101"    # ุงูุฎุฒูุฉ ุงูุฑุฆูุณูุฉ
```

---

### ุงูุฎูุงุฑ 2๏ธโฃ: ุงูุชุฑุญูู ุงูุชุฏุฑูุฌู (ููุตู ุจู ููุดุฑูุงุช ุงููุงุฆูุฉ)

**ุงูููุฑุฉ:** ุงูุงุญุชูุงุธ ุจุงูุญุณุงุจุงุช ุงููุฏููุฉ ูุฅุถุงูุฉ ุงูุฌุฏูุฏุฉ ุชุฏุฑูุฌูุงู

**ุงูุฎุทูุงุช:**
1. ุงุณุชูุฑุงุฏ ุงูุดุฌุฑุฉ ุงูุฌุฏูุฏุฉ ุจุฏูู ุญุฐู ุงููุฏููุฉ
2. ุฑุจุท ุงูุญุณุงุจุงุช ุงููุฏููุฉ ุจุงูุฌุฏูุฏุฉ
3. ุงูุจุฏุก ุจุงุณุชุฎุฏุงู ุงูุญุณุงุจุงุช ุงูุฌุฏูุฏุฉ ูููุนุงููุงุช ุงูุฌุฏูุฏุฉ
4. ุชุฑุญูู ุงูุจูุงูุงุช ุงููุฏููุฉ ุชุฏุฑูุฌูุงู

```bash
# ุงุณุชูุฑุงุฏ ุจุฏูู ุญุฐู
python import_chart_of_accounts.py
```

**ุฅูุดุงุก ุฌุฏูู ุฑุจุท:**
```python
# mapping_old_to_new.py
ACCOUNT_MAPPING = {
    "1200": "112100",  # ุงูุนููุงุก โ ุนููุงุก ุชุฌุงุฑููู
    "4100": "410100",  # ุฅูุฑุงุฏุงุช โ ุฅูุฑุงุฏุงุช ุชุณููู ุฑููู
    "5900": "620004",  # ูุตุฑููุงุช ูุชููุนุฉ โ ุงุดุชุฑุงูุงุช ุจุฑูุฌูุงุช
    "1111": "111101",  # ุงูุฎุฒูุฉ โ ุงูุฎุฒูุฉ ุงูุฑุฆูุณูุฉ
}

def get_new_account_code(old_code: str) -> str:
    """ุชุญููู ุงูููุฏ ุงููุฏูู ุฅูู ุงูุฌุฏูุฏ"""
    return ACCOUNT_MAPPING.get(old_code, old_code)
```

---

### ุงูุฎูุงุฑ 3๏ธโฃ: ุงููุธุงู ุงููุฒุฏูุฌ (ููุดุฑูุงุช ุงููุจูุฑุฉ)

**ุงูููุฑุฉ:** ุชุดุบูู ุงููุธุงููู ูุนุงู ููุชุฑุฉ ุงูุชูุงููุฉ

**ุงูุฎุทูุงุช:**
1. ุงุณุชูุฑุงุฏ ุงูุดุฌุฑุฉ ุงูุฌุฏูุฏุฉ
2. ุฅูุดุงุก ุญุณุงุจุงุช "ุฌุณุฑ" (Bridge Accounts)
3. ุชุดุบูู ุงููุธุงููู ุจุงูุชูุงุฒู ููุฏุฉ 3-6 ุฃุดูุฑ
4. ุงูุชุฑุญูู ุงููุงูู ุจุนุฏ ุงูุชุฃูุฏ ูู ุงูุงุณุชูุฑุงุฑ

```python
# ูู accounting_service.py
class AccountingService:
    # ุงููุธุงู ุงููุฏูู (4 ุฃุฑูุงู)
    ACC_RECEIVABLE_CODE_OLD = "1200"
    SERVICE_REVENUE_CODE_OLD = "4100"
    
    # ุงููุธุงู ุงูุฌุฏูุฏ (6 ุฃุฑูุงู)
    ACC_RECEIVABLE_CODE_NEW = "112100"
    SERVICE_REVENUE_CODE_NEW = "410100"
    
    # ุนูู ุงูุชุจุฏูู
    USE_NEW_SYSTEM = False  # ุบูุฑู ุฅูู True ุนูุฏ ุงูุฌุงูุฒูุฉ
    
    @property
    def ACC_RECEIVABLE_CODE(self):
        return self.ACC_RECEIVABLE_CODE_NEW if self.USE_NEW_SYSTEM else self.ACC_RECEIVABLE_CODE_OLD
    
    @property
    def SERVICE_REVENUE_CODE(self):
        return self.SERVICE_REVENUE_CODE_NEW if self.USE_NEW_SYSTEM else self.SERVICE_REVENUE_CODE_OLD
```

---

## ๐ง ุชุญุฏูุซ ุงูุฃููุงุฏ ุงูุซุงุจุชุฉ ูู ุงูููุฏ

### ุงููููุงุช ุงูุชู ุชุญุชุงุฌ ุชุญุฏูุซ:

#### 1. `services/accounting_service.py`

```python
# ุงูุณุทุฑ 23-27 (ุงููุฏูู)
ACC_RECEIVABLE_CODE = "1200"
SERVICE_REVENUE_CODE = "4100"
DISCOUNT_ALLOWED_CODE = "4300"
VAT_PAYABLE_CODE = "2100"
CASH_ACCOUNT_CODE = "1101"

# ุงูุฌุฏูุฏ (6 ุฃุฑูุงู)
ACC_RECEIVABLE_CODE = "112100"      # ุนููุงุก ุชุฌุงุฑููู
SERVICE_REVENUE_CODE = "410100"     # ุฅูุฑุงุฏุงุช ุฎุฏูุงุช ุงูุชุณููู ุงูุฑููู
DISCOUNT_ALLOWED_CODE = "410300"    # ุฎุตููุงุช (ูููู ุฅุถุงูุชู)
VAT_PAYABLE_CODE = "212200"         # ุถุฑูุจุฉ ุงููููุฉ ุงููุถุงูุฉ
CASH_ACCOUNT_CODE = "111101"        # ุงูุฎุฒูุฉ ุงูุฑุฆูุณูุฉ
```

#### 2. `ui/settings_tab.py`

```python
# ุงูุณุทุฑ 1059-1060 (ุงููุฏูู)
cash_accounts = [acc for acc in all_accounts if acc.code and acc.code.startswith('11')]
revenue_accounts = [acc for acc in all_accounts if acc.code and acc.code.startswith('4')]

# ุงูุฌุฏูุฏ (6 ุฃุฑูุงู)
cash_accounts = [acc for acc in all_accounts if acc.code and acc.code.startswith('111')]
revenue_accounts = [acc for acc in all_accounts if acc.code and acc.code.startswith('41')]
```

---

## ๐ ุณูุฑูุจุช ุงูุชุฑุญูู ุงูุชููุงุฆู

```python
# migrate_accounts.py
"""
ุณูุฑูุจุช ุชุฑุญูู ุงูุญุณุงุจุงุช ูู ุงููุธุงู ุงููุฏูู (4 ุฃุฑูุงู) ุฅูู ุงูุฌุฏูุฏ (6 ุฃุฑูุงู)
"""

import sys
from pathlib import Path
sys.path.insert(0, str(Path(__file__).parent))

from core.repository import Repository
from datetime import datetime

# ุฌุฏูู ุงูุฑุจุท
MIGRATION_MAP = {
    # ุงูุฃุตูู
    "1000": "100000",
    "1100": "110000",
    "1111": "111101",  # ุงูุฎุฒูุฉ ุงูุฑุฆูุณูุฉ
    "1200": "112100",  # ุงูุนููุงุก
    
    # ุงูุฎุตูู
    "2000": "200000",
    "2100": "212200",  # ุถุฑูุจุฉ ุงููููุฉ ุงููุถุงูุฉ
    
    # ุญููู ุงูููููุฉ
    "3000": "300000",
    "3100": "310000",  # ุฑุฃุณ ุงููุงู
    
    # ุงูุฅูุฑุงุฏุงุช
    "4000": "400000",
    "4100": "410100",  # ุฅูุฑุงุฏุงุช ุงูุฎุฏูุงุช
    
    # ุงููุตุฑููุงุช
    "5000": "500000",
    "5900": "620004",  # ูุตุฑููุงุช ูุชููุนุฉ โ ุงุดุชุฑุงูุงุช ุจุฑูุฌูุงุช
}

def migrate_journal_entries():
    """ุชุฑุญูู ูููุฏ ุงูููููุฉ ุฅูู ุงูุฃููุงุฏ ุงูุฌุฏูุฏุฉ"""
    repo = Repository()
    
    print("๐ ุจุฏุก ุชุฑุญูู ูููุฏ ุงูููููุฉ...")
    
    entries = repo.get_all_journal_entries()
    updated_count = 0
    
    for entry in entries:
        needs_update = False
        
        for line in entry.lines:
            old_code = getattr(line, 'account_code', None)
            if old_code and old_code in MIGRATION_MAP:
                new_code = MIGRATION_MAP[old_code]
                line.account_code = new_code
                line.account_id = new_code
                needs_update = True
                print(f"  ุชุญุฏูุซ: {old_code} โ {new_code}")
        
        if needs_update:
            entry_id = getattr(entry, '_mongo_id', None) or str(getattr(entry, 'id', ''))
            repo.update_journal_entry(entry_id, entry)
            updated_count += 1
    
    print(f"โ ุชู ุชุญุฏูุซ {updated_count} ููุฏ ููููุฉ")

def main():
    print("="*60)
    print("๐ ุณูุฑูุจุช ุชุฑุญูู ุงูุญุณุงุจุงุช")
    print("="*60)
    
    confirm = input("\nโ๏ธ  ูู ุฃูุช ูุชุฃูุฏ ูู ุงูุชุฑุญููุ (ูุนู/ูุง): ")
    if confirm.strip() != "ูุนู":
        print("โ ุชู ุฅูุบุงุก ุงูุนูููุฉ")
        return
    
    try:
        migrate_journal_entries()
        print("\n๐ ุชู ุงูุชุฑุญูู ุจูุฌุงุญ!")
    except Exception as e:
        print(f"\nโ ุฎุทุฃ ูู ุงูุชุฑุญูู: {e}")
        import traceback
        traceback.print_exc()

if __name__ == '__main__':
    main()
```

---

## โ ูุงุฆูุฉ ุงูุชุญูู (Checklist)

### ูุจู ุงูุชุฑุญูู:
- [ ] ุนูู ูุณุฎุฉ ุงุญุชูุงุทูุฉ ูุงููุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
- [ ] ุงุฎุชุจุงุฑ ุงูุงุณุชูุฑุงุฏ ุนูู ุจูุฆุฉ ุชุฌุฑูุจูุฉ
- [ ] ูุฑุงุฌุนุฉ ุฌุฏูู ุงูุฑุจุท (MIGRATION_MAP)
- [ ] ุฅุจูุงุบ ุงููุฑูู ุจููุนุฏ ุงูุชุฑุญูู

### ุฃุซูุงุก ุงูุชุฑุญูู:
- [ ] ุฅููุงู ุงููุธุงู ูุคูุชุงู
- [ ] ุชุดุบูู ุณูุฑูุจุช ุงูุงุณุชูุฑุงุฏ
- [ ] ุชุญุฏูุซ ุงูุฃููุงุฏ ูู `accounting_service.py`
- [ ] ุงุฎุชุจุงุฑ ุฅูุดุงุก ููุฏ ููููุฉ ุฌุฏูุฏ

### ุจุนุฏ ุงูุชุฑุญูู:
- [ ] ุงูุชุญูู ูู ุฃุฑุตุฏุฉ ุงูุญุณุงุจุงุช
- [ ] ูุฑุงุฌุนุฉ ูููุฏ ุงูููููุฉ
- [ ] ุงุฎุชุจุงุฑ ุงูุชูุงุฑูุฑ ุงููุงููุฉ
- [ ] ุชุฏุฑูุจ ุงููุฑูู ุนูู ุงููุธุงู ุงูุฌุฏูุฏ

---

## ๐ ุญู ุงููุดุงูู ุงูุดุงุฆุนุฉ

### ุงููุดููุฉ 1: "ุงูุญุณุงุจ ุบูุฑ ููุฌูุฏ"
```
ERROR: Debit account 1200 not found!
```

**ุงูุญู:**
```python
# ุชุญุฏูุซ ุงูููุฏ ูู accounting_service.py
ACC_RECEIVABLE_CODE = "112100"  # ุจุฏูุงู ูู "1200"
```

### ุงููุดููุฉ 2: "ูููุฏ ุงูููููุฉ ุงููุฏููุฉ ูุง ุชุธูุฑ"
```
WARNING: Journal entry references old account code
```

**ุงูุญู:**
```bash
# ุชุดุบูู ุณูุฑูุจุช ุงูุชุฑุญูู
python migrate_accounts.py
```

### ุงููุดููุฉ 3: "ุงูุฃุฑุตุฏุฉ ุบูุฑ ุตุญูุญุฉ"
```
ERROR: Account balance mismatch
```

**ุงูุญู:**
```python
# ุฅุนุงุฏุฉ ุญุณุงุจ ุงูุฃุฑุตุฏุฉ
from core.repository import Repository
repo = Repository()
repo.recalculate_all_balances()
```

---

## ๐ ุงูุฏุนู

ุฅุฐุง ูุงุฌูุช ุฃู ูุดููุฉ:
1. ุฑุงุฌุน ููู `CHART_OF_ACCOUNTS_GUIDE.md`
2. ุชุญูู ูู ููู `README_CHART_OF_ACCOUNTS.md`
3. ุงูุญุต ุงูู logs ูู console

---

**ููุงุญุธุฉ ูุงูุฉ:** ูููุตุญ ุจุงูุชุฑุญูู ูู ููุงูุฉ ุงูุณูุฉ ุงููุงููุฉ ุฃู ุจุฏุงูุฉ ุณูุฉ ูุงููุฉ ุฌุฏูุฏุฉ ูุชุฌูุจ ุงูุชุนููุฏุงุช ุงููุญุงุณุจูุฉ.
